# app_arabic_advanced.py
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import xgboost as xgb
from sklearn.metrics import accuracy_score
from sklearn.model_selection import TimeSeriesSplit
from sklearn.preprocessing import StandardScaler
from PIL import Image
import cv2
import datetime
import random
import ta

# ===== ุฅุนุฏุงุฏ ุงูุตูุญุฉ =====
st.set_page_config(page_title="ูุชุฏุงูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู โ ุงููุณุฎุฉ ุงูุฏูููุฉ ุฌุฏุงู ๐", layout="wide")

# ===== ุงูุฑููุฒ =====
ุฃุณูู = ["AAPL", "MSFT", "GOOGL", "NVDA", "AMZN", "TSLA", "META", "NFLX"]
ุนููุงุช = ["EURUSD=X", "USDJPY=X", "GBPUSD=X", "USDCHF=X", "AUDUSD=X"]
ูู_ุงูุฑููุฒ = ุฃุณูู + ุนููุงุช

# ===== ุงูุดุฑูุท ุงูุฌุงูุจู =====
st.sidebar.header("โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ")
ุฑูุฒ = st.sidebar.selectbox("ุงุฎุชุฑ ุงูุณูู ุฃู ุงูุฒูุฌ:", ูู_ุงูุฑููุฒ)
ุชุงุฑูุฎ_ุงูุจุฏุงูุฉ = st.sidebar.date_input("ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:", datetime.date(2020, 1, 1))
ุชุงุฑูุฎ_ุงูููุงูุฉ = st.sidebar.date_input("ุชุงุฑูุฎ ุงูููุงูุฉ:", datetime.date.today())

ุญุฏ_ุงูุซูุฉ = st.sidebar.slider("ุญุฏ ุงูุซูุฉ (%)", 50, 95, 80)
ููู = st.sidebar.file_uploader("ุฑูุน ุตูุฑุฉ ุงูุชุญููู:", type=["png","jpg","jpeg"])

# ===== ุฏูุงู ูุญุณูุฉ =====

def ุชุญููู_ุงูุจูุงูุงุช(ุฑูุฒ, ุจุฏุงูุฉ, ููุงูุฉ):
    """ุชุญููู ุจูุงูุงุช ูุญุณูุฉ"""
    try:
        ุจูุงูุงุช = yf.download(ุฑูุฒ, start=ุจุฏุงูุฉ, end=ููุงูุฉ, progress=False)
        if ุจูุงูุงุช.empty or len(ุจูุงูุงุช) < 100:
            st.error("โ ุงูุจูุงูุงุช ุบูุฑ ูุงููุฉ. ุชุญุชุงุฌ 100 ููู ุนูู ุงูุฃูู")
            return pd.DataFrame(), ุฑูุฒ
        return ุจูุงูุงุช, ุฑูุฒ
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุงูุชุญููู: {e}")
        return pd.DataFrame(), ุฑูุฒ

def ุญุณุงุจ_ุงููุคุดุฑุงุช_ุงููุชูุฏูุฉ(ุจูุงูุงุช):
    """ุญุณุงุจ ูุคุดุฑุงุช ูููุฉ ูุชูุฏูุฉ"""
    ุจูุงูุงุช = ุจูุงูุงุช.copy()
    
    # ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ
    for ูุชุฑุฉ in [5, 10, 20, 50]:
        ุจูุงูุงุช[f'ูุชูุณุท_{ูุชุฑุฉ}'] = ุจูุงูุงุช['Close'].rolling(ูุชุฑุฉ).mean()
    
    # RSI
    ุจูุงูุงุช['RSI'] = ta.momentum.RSIIndicator(ุจูุงูุงุช['Close'], window=14).rsi()
    
    # MACD
    macd = ta.trend.MACD(ุจูุงูุงุช['Close'])
    ุจูุงูุงุช['MACD'] = macd.macd()
    ุจูุงูุงุช['MACD_ุฅุดุงุฑุฉ'] = macd.macd_signal()
    
    # Bollinger Bands
    bollinger = ta.volatility.BollingerBands(ุจูุงูุงุช['Close'])
    ุจูุงูุงุช['ุจูููุฌุฑ_ุนููู'] = bollinger.bollinger_hband()
    ุจูุงูุงุช['ุจูููุฌุฑ_ุณููู'] = bollinger.bollinger_lband()
    
    # ูุคุดุฑุงุช ุงูุญุฌู
    ุจูุงูุงุช['ุญุฌู_ูุชูุณุท'] = ุจูุงูุงุช['Volume'].rolling(20).mean()
    ุจูุงูุงุช['ูุณุจุฉ_ุงูุญุฌู'] = ุจูุงูุงุช['Volume'] / ุจูุงูุงุช['ุญุฌู_ูุชูุณุท']
    
    # ุงูุชููุจ
    ุจูุงูุงุช['ุชููุจ'] = ุจูุงูุงุช['Close'].pct_change().rolling(20).std()
    
    return ุจูุงูุงุช

def ุชุฌููุฒ_ุงูููุฒุงุช_ุงููุชูุฏูุฉ(ุจูุงูุงุช, ูุน_ุงููุฏู=True):
    """ุชุญุถูุฑ ุงูููุฒุงุช ุงููุชูุฏูุฉ"""
    if ุจูุงูุงุช.empty or len(ุจูุงูุงุช) < 50:
        return None, None, None
    
    try:
        ุจูุงูุงุช = ุญุณุงุจ_ุงููุคุดุฑุงุช_ุงููุชูุฏูุฉ(ุจูุงูุงุช)
        
        ุงูููุฒุงุช = [
            'Open', 'High', 'Low', 'Close', 'Volume',
            'ูุชูุณุท_5', 'ูุชูุณุท_20', 'ูุชูุณุท_50',
            'RSI', 'MACD', 'MACD_ุฅุดุงุฑุฉ',
            'ุจูููุฌุฑ_ุนููู', 'ุจูููุฌุฑ_ุณููู', 'ูุณุจุฉ_ุงูุญุฌู', 'ุชููุจ'
        ]
        
        # ููุก ุงูููู ุงููุงูุตุฉ
        ุจูุงูุงุช = ุจูุงูุงุช.fillna(method='ffill').fillna(0)
        
        if ูุน_ุงููุฏู:
            ุจูุงูุงุช["ุงููุฏู"] = (ุจูุงูุงุช['Close'].shift(-1) > ุจูุงูุงุช['Close']).astype(int)
            ุจูุงูุงุช_ูุธููุฉ = ุจูุงูุงุช.iloc[:-1].copy()
            
            if ุจูุงูุงุช_ูุธููุฉ.empty:
                return None, None, None
                
            X = ุจูุงูุงุช_ูุธููุฉ[ุงูููุฒุงุช]
            y = ุจูุงูุงุช_ูุธููุฉ["ุงููุฏู"]
            return X, y, ุจูุงูุงุช_ูุธููุฉ
        else:
            X = ุจูุงูุงุช[ุงูููุฒุงุช]
            return X, ุจูุงูุงุช, None
            
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุชุฌููุฒ ุงูููุฒุงุช: {str(e)}")
        return None, None, None

def ุชุฏุฑูุจ_ูููุฐุฌ_ูุชูุฏู(ุจูุงูุงุช):
    """ุชุฏุฑูุจ ูููุฐุฌ ูุชูุฏู"""
    X, y, ุจูุงูุงุช_ูุนุฏูุฉ = ุชุฌููุฒ_ุงูููุฒุงุช_ุงููุชูุฏูุฉ(ุจูุงูุงุช, ูุน_ุงููุฏู=True)
    
    if X is None or y is None or len(X) < 100:
        st.warning("โ ุชุญุชุงุฌ ุฅูู 100 ููุทุฉ ุจูุงูุงุช ุนูู ุงูุฃูู ููุชุฏุฑูุจ ุงููุชูุฏู")
        return None, None, None
    
    try:
        # ุชูุณูู ุงูุจูุงูุงุช ุงูุฒููู
        tscv = TimeSeriesSplit(n_splits=5)
        ูููุงุณ = StandardScaler()
        
        X_ูููุณ = ูููุงุณ.fit_transform(X)
        
        ูููุฐุฌ = xgb.XGBClassifier(
            n_estimators=300,
            max_depth=6,
            learning_rate=0.05,
            subsample=0.8,
            colsample_bytree=0.8,
            reg_alpha=0.1,
            tree_method="hist",
            use_label_encoder=False,
            eval_metric="logloss",
            random_state=42
        )
        
        # ุชุฏุฑูุจ ูุน ุชุญูู ูุชูุงุทุน
        ุฏุฑุฌุงุช_ุงูุฏูุฉ = []
        for ุชุฏุฑูุจ, ุงุฎุชุจุงุฑ in tscv.split(X_ูููุณ):
            X_ุชุฏุฑูุจ, X_ุงุฎุชุจุงุฑ = X_ูููุณ[ุชุฏุฑูุจ], X_ูููุณ[ุงุฎุชุจุงุฑ]
            y_ุชุฏุฑูุจ, y_ุงุฎุชุจุงุฑ = y.iloc[ุชุฏุฑูุจ], y.iloc[ุงุฎุชุจุงุฑ]
            
            ูููุฐุฌ.fit(X_ุชุฏุฑูุจ, y_ุชุฏุฑูุจ)
            ุฏุฑุฌุงุช_ุงูุฏูุฉ.append(accuracy_score(y_ุงุฎุชุจุงุฑ, ูููุฐุฌ.predict(X_ุงุฎุชุจุงุฑ)))
        
        ูุชูุณุท_ุงูุฏูุฉ = np.mean(ุฏุฑุฌุงุช_ุงูุฏูุฉ)
        
        # ุงูุชุฏุฑูุจ ุงูููุงุฆู ุนูู ูู ุงูุจูุงูุงุช
        ูููุฐุฌ.fit(X_ูููุณ, y)
        
        return ูููุฐุฌ, ูุชูุณุท_ุงูุฏูุฉ, ูููุงุณ
        
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุงูุชุฏุฑูุจ: {str(e)}")
        return None, None, None

def ุชูุจุค_ูุน_ุซูุฉ(ูููุฐุฌ, ูููุงุณ, ุจูุงูุงุช):
    """ุงูุชูุจุค ูุน ุญุณุงุจ ุฏุฑุฌุฉ ุงูุซูุฉ"""
    X_ุชูุจุค, ุจูุงูุงุช_ูุนุฏูุฉ, _ = ุชุฌููุฒ_ุงูููุฒุงุช_ุงููุชูุฏูุฉ(ุจูุงูุงุช, ูุน_ุงููุฏู=False)
    
    if X_ุชูุจุค is None or X_ุชูุจุค.empty:
        return None, None
    
    try:
        X_ูููุณ = ูููุงุณ.transform(X_ุชูุจุค)
        
        ุชูุจุค = ูููุฐุฌ.predict(X_ูููุณ[-1:])[0]
        ุงุญุชูุงูุงุช = ูููุฐุฌ.predict_proba(X_ูููุณ[-1:])[0]
        
        ุซูุฉ = max(ุงุญุชูุงูุงุช) * 100
        
        return ุชูุจุค, ุซูุฉ
        
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุงูุชูุจุค: {str(e)}")
        return None, None

def ุชุญููู_ุตูุฑุฉ_ูุชูุฏู(ููู):
    """ุชุญููู ูุชูุฏู ููุตูุฑ"""
    try:
        ุตูุฑุฉ = Image.open(ููู).convert("RGB")
        ุตูุฑุฉ = ุตูุฑุฉ.resize((400, 400))
        
        img_cv = np.array(ุตูุฑุฉ)
        ุฑูุงุฏู = cv2.cvtColor(img_cv, cv2.COLOR_RGB2GRAY)
        
        ูุชูุณุท_ุงูุฅุถุงุกุฉ = np.mean(ุฑูุงุฏู)
        ุชุจุงูู = np.std(ุฑูุงุฏู)
        
        # ุชุญููู ุงูุญูุงู
        ุญูุงู = cv2.Canny(ุฑูุงุฏู, 50, 150)
        ูุซุงูุฉ_ุงูุญูุงู = np.sum(ุญูุงู > 0) / ุญูุงู.size
        
        # ูุธุงู ุชุณุฌูู
        ููุงุท = 0
        if ูุชูุณุท_ุงูุฅุถุงุกุฉ > 130: ููุงุท += 1
        if ูุซุงูุฉ_ุงูุญูุงู > 0.1: ููุงุท += 1
        if ุชุจุงูู > 40: ููุงุท += 1
        
        st.image(ุตูุฑุฉ, caption="๐ ุงูุตูุฑุฉ ุงููุญููุฉ", use_column_width=False, width=300)
        
        st.write("**ุชุญููู ุงูุตูุฑุฉ:**")
        st.write(f"๐ ูุชูุณุท ุงูุฅุถุงุกุฉ: {ูุชูุณุท_ุงูุฅุถุงุกุฉ:.1f}")
        st.write(f"๐ฏ ูุซุงูุฉ ุงูุญูุงู: {ูุซุงูุฉ_ุงูุญูุงู:.3f}")
        st.write(f"๐ ุงูุชุจุงูู: {ุชุจุงูู:.1f}")
        st.write(f"โญ ุงูููุงุท: {ููุงุท}/3")
        
        return 1 if ููุงุท >= 2 else 0, ููุงุท
        
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุชุญููู ุงูุตูุฑุฉ: {str(e)}")
        return None, 0

# ===== ูุงุฌูุฉ ุงูุชุทุจูู =====
st.title("๐ฏ ูุชุฏุงูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู โ ุงููุณุฎุฉ ุงูุฏูููุฉ ุฌุฏุงู ๐")
st.warning("โ **ุชุญุฐูุฑ:** ูุฐู ุฃุฏุงุฉ ุชุนููููุฉ. ุงูุชุฏุงูู ุงููุนูู ูุญูู ูุฎุงุทุฑ.")

if st.button("๐ ุจุฏุก ุงูุชุญููู ุงูุฏููู"):
    with st.spinner("๐ฌ ุฌุงุฑู ุงูุชุญููู ุงููุชุนูู..."):

        # ุชุญููู ุงูุจูุงูุงุช
        ุจูุงูุงุช, ุฑูุฒ_ูุณุชุฎุฏู = ุชุญููู_ุงูุจูุงูุงุช(ุฑูุฒ, ุชุงุฑูุฎ_ุงูุจุฏุงูุฉ, ุชุงุฑูุฎ_ุงูููุงูุฉ)
        if ุจูุงูุงุช.empty:
            st.stop()
        
        st.success(f"โ ุชู ุชุญููู {len(ุจูุงูุงุช)} ููู ุชุฏุงูู ูู {ุฑูุฒ_ูุณุชุฎุฏู}")
        
        # ุนุฑุถ ุฅุญุตุงุฆูุงุช
        st.write("### ๐ ุงูุฅุญุตุงุฆูุงุช ุงูุฃุณุงุณูุฉ:")
        ุนููุฏ1, ุนููุฏ2, ุนููุฏ3 = st.columns(3)
        
        with ุนููุฏ1:
            st.metric("ูุชูุณุท ุงูุฅุบูุงู", f"{ุจูุงูุงุช['Close'].mean():.2f}")
        with ุนููุฏ2:
            st.metric("ุฃุนูู ุณุนุฑ", f"{ุจูุงูุงุช['High'].max():.2f}")
        with ุนููุฏ3:
            st.metric("ุฃูู ุณุนุฑ", f"{ุจูุงูุงุช['Low'].min():.2f}")
        
        # ูุคุดุฑุงุช ูููุฉ ุญุงููุฉ
        st.write("### ๐ ุงููุคุดุฑุงุช ุงููููุฉ ุงูุญุงููุฉ:")
        ุนููุฏ4, ุนููุฏ5, ุนููุฏ6 = st.columns(3)
        
        with ุนููุฏ4:
            rsi_ุญุงูู = ta.momentum.RSIIndicator(ุจูุงูุงุช['Close']).rsi().iloc[-1]
            st.metric("RSI", f"{rsi_ุญุงูู:.1f}")
        with ุนููุฏ5:
            ุณุนุฑ_ุญุงูู = ุจูุงูุงุช['Close'].iloc[-1]
            ูุชูุณุท_50 = ุจูุงูุงุช['Close'].rolling(50).mean().iloc[-1]
            st.metric("ุงูุณุนุฑ vs ุงููุชูุณุท 50", f"{ุณุนุฑ_ุญุงูู:.2f}")
        with ุนููุฏ6:
            ุชููุจ = ุจูุงูุงุช['Close'].pct_change().std() * 100
            st.metric("ุงูุชููุจ", f"{ุชููุจ:.2f}%")
        
        # ุชุฏุฑูุจ ุงููููุฐุฌ
        ูููุฐุฌ, ุฏูุฉ, ูููุงุณ = ุชุฏุฑูุจ_ูููุฐุฌ_ูุชูุฏู(ุจูุงูุงุช)
        
        if ูููุฐุฌ is None:
            st.error("โ ูุดู ูู ุชุฏุฑูุจ ุงููููุฐุฌ")
            st.stop()
        
        # ุงูุชูุจุค
        ุชูุจุค, ุซูุฉ = ุชูุจุค_ูุน_ุซูุฉ(ูููุฐุฌ, ูููุงุณ, ุจูุงูุงุช)
        
        if ุชูุจุค is not None:
            st.write("### ๐ฏ ูุชุงุฆุฌ ุงูุชุญููู ุงูุฏููู:")
            
            # ุนุฑุถ ุงููุชุงุฆุฌ
            if ุชูุจุค == 1:
                st.success(f"**ุงูุงุชุฌุงู: ๐ ุตุงุนุฏ**")
            else:
                st.error(f"**ุงูุงุชุฌุงู: ๐ ูุงุจุท**")
            
            st.info(f"**ุฏูุฉ ุงููููุฐุฌ: {ุฏูุฉ*100:.2f}%**")
            st.info(f"**ุฏุฑุฌุฉ ุงูุซูุฉ: {ุซูุฉ:.1f}%**")
            
            # ุชูุตูุงุช
            st.write("### ๐ก ุงูุชูุตูุงุช:")
            if ุชูุจุค == 1 and ุซูุฉ >= ุญุฏ_ุงูุซูุฉ:
                st.success("""
                **ุฅุดุงุฑุฉ ุดุฑุงุก ูููุฉ:**
                - ุงุชุฌุงู ุตุงุนุฏ ูุน ุซูุฉ ุนุงููุฉ
                - ูุฑุตุฉ ุฌูุฏุฉ ููุฏุฎูู ูู ุตููุฉ
                - ุถุน ููู ุงูุฎุณุงุฑุฉ ุนูุฏ 2-3%
                """)
            elif ุชูุจุค == 0 and ุซูุฉ >= ุญุฏ_ุงูุซูุฉ:
                st.error("""
                **ุฅุดุงุฑุฉ ุจูุน ูููุฉ:**
                - ุงุชุฌุงู ูุงุจุท ูุน ุซูุฉ ุนุงููุฉ
                - ุชุฌูุจ ุงูุดุฑุงุก ุญุงููุงู
                - ูุฑุตุฉ ููุฏุฎูู ูู ุตููุงุช ุจูุน
                """)
            else:
                st.warning("""
                **ุฅุดุงุฑุฉ ูุญุงูุฏุฉ:**
                - ุงูุซูุฉ ุบูุฑ ูุงููุฉ
                - ุงูุงูุชุธุงุฑ ุฃูุถู ุฎูุงุฑ
                - ุงุจุญุซ ุนู ุชุฃููุฏุงุช ุฅุถุงููุฉ
                """)
        
        # ุชุญููู ุงูุตูุฑุฉ
        if ููู is not None:
            st.write("### ๐ท ุชุญููู ุงูุตูุฑุฉ:")
            ุชุญููู_ุตูุฑุฉ, ููุงุท = ุชุญููู_ุตูุฑุฉ_ูุชูุฏู(ููู)
            
            if ุชุญููู_ุตูุฑุฉ == 1:
                st.success("**ูุชูุฌุฉ ุงูุตูุฑุฉ: ๐ ุฅูุฌุงุจูุฉ**")
            elif ุชุญููู_ุตูุฑุฉ == 0:
                st.error("**ูุชูุฌุฉ ุงูุตูุฑุฉ: ๐ ุณูุจูุฉ**")
        
        # ุนุฑุถ ุงูุจูุงูุงุช
        with st.expander("๐ ุนุฑุถ ุงูุจูุงูุงุช ุงููุงููุฉ"):
            st.dataframe(ุจูุงูุงุช.tail(10))
            
            # ุฑุณู ุจูุงูู
            st.write("**ุขุฎุฑ 100 ููู ุชุฏุงูู:**")
            st.line_chart(ุจูุงูุงุช['Close'].tail(100))

st.markdown("---")
st.write("### ๐ ููุงุญุธุงุช ูููุฉ:")
st.info("""
- ุงุณุชุฎุฏู ุจูุงูุงุช ุชุงุฑูุฎูุฉ ุทูููุฉ (ุณูุชูู ุนูู ุงูุฃูู)
- ุฏุฑุฌุฉ ุงูุซูุฉ ูููุฉ ูููุฉ ุงูุฅุดุงุฑุฉ
- ูุง ุชุนุชูุฏ ุนูู ุฅุดุงุฑุฉ ูุงุญุฏุฉ ููุท
- ูุฐู ุฃุฏุงุฉ ุชุนููููุฉ ูุงุณุชุดุงุฑูุฉ
- ุงุณุชุดุฑ ูุชุฎุตุตุงู ูุจู ุงูุชุฏุงูู ุงููุนูู
""")